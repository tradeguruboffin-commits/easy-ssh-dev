#!/usr/bin/env bash
# =========================================================
# esey-ssh-dev â€” Portable Arch Aware Clean Build Script
# Author: Sumit
# =========================================================

set -Eeuo pipefail

trap 'rc=$?; echo "âŒ Error on line $LINENO. Exit code: $rc"; exit $rc' ERR

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GUI="$PROJECT_ROOT/gui"
LIB="$GUI/lib"
BIN="$PROJECT_ROOT/bin"

echo "ğŸ“ Project root: $PROJECT_ROOT"

echo "ğŸ” Detecting architecture..."
ARCH=$(uname -m)
echo "Architecture: $ARCH"

# ---------------- Dependency Check ----------------

need() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "âŒ $1 not installed."
    exit 1
  }
}

echo "ğŸ“¦ Checking build dependencies..."

need go
need python3
need pip3

# venv check
python3 -m venv --help >/dev/null 2>&1 || {
  echo "âŒ python3-venv not installed."
  exit 1
}

# tkinter check
python3 - <<EOF >/dev/null 2>&1
import tkinter
EOF
if [ $? -ne 0 ]; then
  echo "âŒ python3-tk not installed."
  exit 1
fi

echo "âœ… All required dependencies found."

# ---------------- Clean Old Binaries ----------------

echo "ğŸ§¹ Removing old binaries..."

mkdir -p "$BIN"
rm -f "$BIN/sshx" \
      "$BIN/sshx-dev" \
      "$GUI/sshx-gui" \
      "$LIB/git-auth" \
      "$LIB/sshx-reset"

# ---------------- Build Go Binaries ----------------

echo "ğŸš€ Building Go binaries..."

cd "$PROJECT_ROOT"
./build-sshx
./build-init

cd "$LIB"
./build-git-auth

# ---------------- Python Build ----------------

echo "ğŸ Creating virtual environment..."

cd "$PROJECT_ROOT"
python3 -m venv .venv
source .venv/bin/activate

pip install --upgrade pip
pip install pyinstaller

echo "ğŸ–¥ Building GUI..."
cd "$GUI"
./build-gui

echo "ğŸ” Building reset helper..."
cd "$LIB"
./build-reset

# ---------------- Move Built Files ----------------

echo "ğŸ“¦ Moving built binaries..."

mv -f "$GUI/dist/sshx-gui" "$GUI/" 2>/dev/null || true

rm -rf "$GUI/dist" "$GUI/build" "$GUI/sshx-gui.spec"

mv -f "$LIB/dist/sshx-reset" "$LIB/" 2>/dev/null || true

rm -rf "$LIB/dist" "$LIB/build" "$LIB/sshx-reset.spec"

# ---------------- Cleanup ----------------

echo "ğŸ§¼ Cleaning virtual environment..."

deactivate 2>/dev/null || true
rm -rf "$PROJECT_ROOT/.venv"

echo ""
echo "âœ… Clean portable build successful!"
echo ""
if command -v tree >/dev/null 2>&1; then
  tree "$PROJECT_ROOT"
else
  echo "ğŸ“ Build complete."
fi
