#!/usr/bin/env bash
set -euo pipefail

# ==========================================================
#  esey-ssh-dev Portable Installer
# ==========================================================

# Detect project root automatically
SCRIPT_PATH="$(readlink -f "$0")"
BASE_DIR="$(dirname "$SCRIPT_PATH")"

TARGET_DIR="/usr/local/bin"

BINARIES=(
    "bin/sshx"
    "bin/sshx-key"
    "gui/lib/sshx-cpy"
    "gui/lib/sshx-reset"
    "gui/lib/git-auth"
    "gui/sshx-gui"
)

# Colors
GREEN="\e[32m"; BLUE="\e[34m"; RED="\e[31m"; NC="\e[0m"; BOLD="\e[1m"

log()   { echo -e "${BLUE}${BOLD}$1${NC}"; }
ok()    { echo -e "${GREEN}âœ” $1${NC}"; }
error() { echo -e "${RED}âœ˜ $1${NC}"; exit 1; }

install() {
    log "ðŸš€ Installing esey-ssh-dev..."

    # -----------------------------
    # Link binaries
    # -----------------------------
    for bin in "${BINARIES[@]}"; do
        SRC="$BASE_DIR/$bin"
        NAME="$(basename "$bin")"
        DEST="$TARGET_DIR/$NAME"

        [[ -f "$SRC" ]] || error "Missing binary: $SRC"

        if [[ -e "$DEST" || -L "$DEST" ]]; then
            echo "Removing existing $DEST"
            sudo rm -f "$DEST"
        fi

        sudo ln -s "$SRC" "$DEST"
        ok "$NAME linked â†’ $DEST"
    done

    # -----------------------------
    # Desktop Entry Handling
    # -----------------------------
    DESKTOP_DIR="$HOME/.local/share/applications"
    mkdir -p "$DESKTOP_DIR"
    DESKTOP_FILE="$DESKTOP_DIR/sshx-gui.desktop"

    # Remove existing desktop entry if exists
    if [[ -f "$DESKTOP_FILE" ]]; then
        rm -f "$DESKTOP_FILE"
        ok "Old desktop entry removed"
    fi

    # Detect portable icon
    ICON_PATH="$BASE_DIR/bin/ssh-terminal.png"
    if [[ ! -f "$ICON_PATH" ]]; then
        echo "Warning: Icon not found, desktop entry will not use custom icon"
        ICON_PATH=""
    fi

    cat > "$DESKTOP_FILE" <<EOF
[Desktop Entry]
Version=1.0
Type=Application
Name=SSHX
Comment=SSH GUI Manager for QEMU / VMs
Exec=sshx-gui
Icon=$ICON_PATH
Terminal=false
Categories=System;Network;
StartupNotify=true
Path=$BASE_DIR
EOF

    chmod +x "$DESKTOP_FILE"

    # Refresh desktop database (optional but good practice)
    update-desktop-database "$DESKTOP_DIR" >/dev/null 2>&1 || true

    ok "Desktop entry created â†’ $DESKTOP_FILE"
    ok "Installation complete ðŸŽ‰"
}

uninstall() {
    log "ðŸ—‘ Uninstalling esey-ssh-dev..."

    # Remove linked binaries
    for bin in "${BINARIES[@]}"; do
        NAME="$(basename "$bin")"
        DEST="$TARGET_DIR/$NAME"

        if [[ -e "$DEST" || -L "$DEST" ]]; then
            sudo rm -f "$DEST"
            ok "$NAME removed"
        else
            echo "$NAME not found in $TARGET_DIR"
        fi
    done

    # Remove desktop entry
    DESKTOP_FILE="$HOME/.local/share/applications/sshx-gui.desktop"
    if [[ -f "$DESKTOP_FILE" ]]; then
        rm -f "$DESKTOP_FILE"
        ok "Desktop entry removed"
    fi

    update-desktop-database "$HOME/.local/share/applications" >/dev/null 2>&1 || true

    ok "Uninstall complete âœ…"
}

# ===================== CLI =====================

case "${1:-}" in
    install)
        install
        ;;
    uninstall)
        uninstall
        ;;
    *)
        echo "Usage:"
        echo "  $0 install"
        echo "  $0 uninstall"
        exit 1
        ;;
esac
