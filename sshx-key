#!/bin/bash
# =========================================================
# GitHub SSH Key Setup - Non-Interactive, Portable Version
# Author: Sumit
# =========================================================

set -euo pipefail
IFS=$'\n\t'

# ---------------- Colors ----------------
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ---------------- Input Validation ----------------
if [ -z "${1:-}" ]; then
    echo -e "${RED}âŒ Error: Email address required${NC}"
    echo "Usage: $0 your_email@example.com"
    exit 1
fi

EMAIL="$1"
SSH_DIR="$HOME/.ssh"
SSH_KEY="$SSH_DIR/id_ed25519"

echo -e "${GREEN}ğŸš€ Starting GitHub SSH setup for: $EMAIL${NC}\n"

# ---------------- Ensure .ssh directory exists ----------------
mkdir -p "$SSH_DIR"
chmod 700 "$SSH_DIR"

# ---------------- Generate SSH Key if Missing ----------------
if [ ! -f "$SSH_KEY" ]; then
    echo -e "${GREEN}ğŸ”‘ Generating new SSH key...${NC}"
    ssh-keygen -t ed25519 -C "$EMAIL" -f "$SSH_KEY" -N "" >/dev/null
    echo -e "${GREEN}âœ“ SSH key generated at $SSH_KEY${NC}\n"
else
    echo -e "${YELLOW}âš  SSH key already exists at $SSH_KEY${NC}"
    echo -e "âœ“ Using existing key\n"
fi

# ---------------- Start SSH Agent ----------------
if ! pgrep -u "$USER" ssh-agent >/dev/null; then
    echo -e "${GREEN}ğŸ”„ Starting SSH agent...${NC}"
    eval "$(ssh-agent -s)" >/dev/null
    echo -e "${GREEN}âœ“ SSH agent started${NC}\n"
else
    echo -e "${YELLOW}âš  SSH agent already running${NC}\n"
fi

# ---------------- Add SSH Key to Agent ----------------
echo -e "${GREEN}â• Adding key to SSH agent...${NC}"
ssh-add "$SSH_KEY" >/dev/null
echo -e "${GREEN}âœ“ Key added to SSH agent${NC}\n"

# ---------------- Copy Public Key to Clipboard ----------------
PUB_KEY=$(cat "${SSH_KEY}.pub")
CLIPBOARD_COPIED=false

if command -v xclip >/dev/null; then
    echo "$PUB_KEY" | xclip -selection clipboard
    CLIPBOARD_COPIED=true
elif command -v pbcopy >/dev/null; then
    echo "$PUB_KEY" | pbcopy
    CLIPBOARD_COPIED=true
elif command -v clip.exe >/dev/null; then
    echo "$PUB_KEY" | clip.exe
    CLIPBOARD_COPIED=true
fi

if $CLIPBOARD_COPIED; then
    echo -e "${GREEN}âœ“ Public key copied to clipboard${NC}\n"
else
    echo -e "${YELLOW}âš  Could not copy to clipboard automatically${NC}\n"
fi

# ---------------- Display Instructions ----------------
echo -e "${BLUE}Next Steps:${NC}"
echo "1. Go to: https://github.com/settings/keys"
echo "2. Click 'New SSH key'"
echo "3. Paste the public key below (or copied to clipboard)"
echo "4. Give it a title and click 'Add SSH key'\n"

# ---------------- Output Public Key ----------------
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${PUB_KEY}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

# ---------------- Test Instructions ----------------
echo -e "${YELLOW}To test your connection:${NC}"
echo "ssh -T git@github.com"
echo ""

echo -e "${GREEN}âœ… GitHub SSH Setup Completed Successfully!${NC}"
