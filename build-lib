#!/bin/bash
# build-lib â€” Unified Go Builder for lib binaries

set -Eeuo pipefail

OUTPUT_DIR="./lib"
mkdir -p "$OUTPUT_DIR"

# List of source files
SOURCES=(
    "git-auth.go"
    "sshx-cpy.go"
    "sshx-reset.go"
)

echo "ðŸš€ Starting unified build..."
echo "ðŸ“¦ Using -trimpath -ldflags='-s -w'"
echo "--------------------------------------"

for SOURCE_FILE in "${SOURCES[@]}"; do

    if [[ ! -f "$SOURCE_FILE" ]]; then
        echo "âš  Skipping $SOURCE_FILE (not found)"
        continue
    fi

    BINARY_NAME="${SOURCE_FILE%.go}"
    OUTPUT_PATH="$OUTPUT_DIR/$BINARY_NAME"

    echo ""
    echo "ðŸ”¨ Building $BINARY_NAME..."

    # Previous size check
    if [[ -f "$OUTPUT_PATH" ]]; then
        before=$(wc -c < "$OUTPUT_PATH")
    else
        before=0
    fi

    go build -trimpath -ldflags="-s -w" -o "$OUTPUT_PATH" "$SOURCE_FILE"

    after=$(wc -c < "$OUTPUT_PATH")

    echo "âœ… Built: $OUTPUT_PATH"

    if [[ $before -gt 0 ]]; then
        reduction=$(awk "BEGIN {pc=($before-$after)*100/$before; printf \"%.1f\", pc}")
        echo "ðŸ“Š Previous: ${before}B â†’ Now: ${after}B"
        echo "ðŸ’¾ Size change: ${reduction}%"
    else
        echo "ðŸ“Š Size: ${after}B"
    fi

done

echo ""
echo "--------------------------------------"
echo "âœ… lib binaries builds completed! ðŸ†—"
